<!DOCTYPE html>
<html>
  <head>
    <title>GrooveStomp</title>
    <link rel="stylesheet" type="text/css" href="/css/style.css">
  </head>
  <body>
    <div id="navigation">
      <ul>
        <li><a href="/">Home</a></li>
        <li><a href="/tags">Post Tags</a></li>
        <li><a href="/projects">Projects</a></li>
        <li><a href="/about">About</a></li>
        <li><a href="/index.xml">Rss</a></li>
      </ul>
    </div>

<div id="content-container">
  <div class="post">
    <div class="float-container">
      <h1>Ruby Loadpath Confusion</h1>
      <span class="date">2014-04-29</span>
    </div>
    <p>The main application at work was developed in Ruby on Rails, with supporting
services written in Java and PHP. We&rsquo;ve recently rewritten the PHP service in
Java, but haven&rsquo;t fully deprecated the old PHP code yet.  All of our
applications and services run on Amazon&rsquo;s AWS.</p>

<p>Going forward we will be trying to gut our monolithic app into many services,
and we&rsquo;re using Vert.x as the underlying technology core to do that.
There&rsquo;s a new feature we&rsquo;re building that we&rsquo;ll be deploying on this new
service infrastructure.  We&rsquo;re continuing to use Ruby on the JVM with Vert.x.</p>

<p>A coworker has built a JRuby service on Vert.x to implement this new feature,
and this is complete to the point where specs are now being written.
When launched as a Vert.x application, everything works fine.  When launched
in test mode the application is unable to find all the appropriate paths
to load required libraries.</p>

<p>When I saw the project I immediately noticed the project structure:</p>

<pre><code>-app_root
|+config
|+controllers
|+lib
|+models
|+service_objects
|-spec
 |-models
  |-my_model_spec.rb
  |...
 |+controllers
 |-spec_helper.rb
|-init.rb
|...
</code></pre>

<p>Any given spec has this at the top:</p>

<pre><code class="language-ruby">require 'spec_helper'
</code></pre>

<p>This was new to me at the time, but
<a href="http://diminishing.org/require-spec-helper/">RSpec modifies <code>$LOAD_PATH</code> directly</a>
so requiring spec_helper is simpler.</p>

<p>In attempt to help the testing suite load all dependencies properly, my
coworker attempted to eagerly load everything. So at the top of <code>spec_helper</code>
was:</p>

<pre><code class="language-ruby">$LOAD_PATH.unshift File.join(File.expand_path(File.dirname(__FILE__), '../'), 'lib/**/*')
</code></pre>

<p>It&rsquo;s important to note here that modifying <code>$LOAD_PATH</code> does not actually
load anything.  What it does is allow Ruby to find files in the directories specified.</p>

<p>Maybe the solution is clear to you now.
In our models, we&rsquo;re trying to <code>require</code> files from <code>lib/</code>.
The trick is that individual specs are run such that the active directory is
the directory of that spec.  So, in the case of <code>my_model_spec.rb</code> the active
directory would be:</p>

<pre><code class="language-bash">app_root/spec/models
</code></pre>

<p>Clearly there is no <code>lib/</code> directory there.
The modification to <code>$LOAD_PATH</code> didn&rsquo;t help because there is still no
<code>lib/</code> directory visible.</p>

<p>The solution was to modify <code>$LOAD_PATH</code> in this way:</p>

<pre><code class="language-ruby">$LOAD_PATH.unshift File.join(File.expand_path(File.dirname(__FILE__), '../'))
</code></pre>

<p>This effectively puts <code>app_root</code> onto the <code>$LOAD_PATH</code>, so that Ruby will
find <code>app_root/lib</code> for all <code>require</code> statements.</p>

  </div>

  <div id="pagination">
    <ul>
      
      <li><a href="http://127.0.0.1:1234/2014/09/21/ruminations-on-writing/">Older</a></li>
      
      
      <li><a href="http://127.0.0.1:1234/2014/03/09/bangbangcon/">Newer</a></li>
      
    </ul>
  </div>
</div>
  </body>
</html>

